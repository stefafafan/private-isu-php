# 作業詳細ログ

ここには private-isu を解くにあたって実施している詳細の作業ログを記載します。

## 事前準備

競技用インスタンスにsshする。

```sh
ssh -i <.pemファイル> ubuntu@<Public IPv4 address>
```

isuconユーザに切り替えて、ホームディレクトリに移動

```sh
sudo su isucon
cd ~
```

### 初期データの準備

```sh
mkdir private_isu/webapp/sq
cd private_isu/
make init
```

MySQLコマンドへデータを流し込む (数分かかる)。

```sh
bunzip2 -c webapp/sql/dump.sql.bz2 | mysql -uisuconp -pisuconp
```

### 鍵の登録、~/.ssh/configの作成

`~/.ssh/authorized_keys` ファイルを作成する。isuconユーザに対して権限を付与する。

```sh
sudo mkdir ~/.ssh
sudo touch ~/.ssh/authorized_keys
sudo chown -R isucon:isucon ~/.ssh
```

GitHubの鍵を登録。

```sh
curl https://github.com/<あなたのGitHubユーザID>.keys >> ~/.ssh/authorized_keys
```

ログアウトし、pemファイルなしでログインできることを確認する。

```sh
ssh isucon@<Public IPv4 addressの値>
```

ベンチマーク用インスタンスでも同様の作業を実施する。

```sh
# ローカル
ssh -i <.pemファイル> ubuntu@<Public IPv4 address>

# サーバ上
sudo su isucon
cd ~
sudo mkdir ~/.ssh
sudo touch ~/.ssh/authorized_keys
sudo chown -R isucon:isucon ~/.ssh
curl https://github.com/<あなたのGitHubユーザID>.keys >> ~/.ssh/authorized_keys

# ローカルで確認
ssh isucon@<Public IPv4 addressの値>
```

必要な設定が終わったので、 `~/.ssh/config` を手元向けに作成する。中身は以下のような形（IPアドレスの値は実際の値と置き換える）。

```sh
Host isu01
  User isucon
  HostName <Public IPv4 addressの値>
Host isubench
  User isucon
  HostName <Public IPv4 addressの値>
```

設定が終わったら以下のようにssh可能になる。

```sh
ssh isu01
ssh isubench
```

## 動作確認とベンチマーカーの実行

競技用インスタンスのPublic IPv4 addressに直接ブラウザで (httpで) アクセスしたら「Iscogram」という名前のアプリが確認できる。

ベンチマーカーの実行はベンチマーカー用インスタンス上で以下のように実行する。

```sh
# sshした上で、
ssh isubench

# ベンチマーク実行
/home/isucon/private_isu.git/benchmarker/bin/benchmarker -u /home/isucon/private_isu.git/benchmarker/userdata -t http://<競技用インスタンスのPrivate IPv4 addresseの値>
```

以下のようなログが出力されます。

```sh
{"pass":true,"score":1026,"success":889,"fail":0,"messages":[]}
```

## rsync で必要なファイルだけ手元に持ってきて、GitHubへpushする

`isu01` 上のディレクトリ構成の感じを見つつ、以下のようなコマンドで不要なディレクトリを除外しつつ `webapp` 配下を持ってくる。

```sh
rsync -a --exclude 'sql' --exclude 'golang' --exclude 'node' --exclude 'ruby' isu01:~/private_isu/webapp ./
```

`webapp/docker-compose.yml` と `webapp/etc` は正直いらなそうなので手元から除外しつつ、必要なファイルだけ GitHub にpushしておく。

まず `.gitignore` に `vendor` を入れておく。

```.gitignore
vendor
```

その上で残りの `webapp` もcommitしてpushする。

## webapp/php 以下をサーバへ rsync

手元で composer install しつつ

```sh
cd webapp/php
composer install
```

webapp/php のみ rsyncでアップロードする。

```sh
rsync -a webapp/php/ isu01:~/private_isu/webapp/php/
```

## PHP実装に切り替え

[マニュアル](https://github.com/catatsuy/private-isu/blob/master/manual.md) に従ってPHP実装に切り替える。

```sh
sudo systemctl stop isu-ruby
sudo systemctl disable isu-ruby
sudo rm /etc/nginx/sites-enabled/isucon.conf
sudo ln -s /etc/nginx/sites-available/isucon-php.conf /etc/nginx/sites-enabled/
sudo systemctl reload nginx
sudo systemctl start php8.3-fpm
sudo systemctl enable php8.3-fpm
```

ログを確認する
```sh
$ sudo journalctl -f -u php8.3-fpm
Nov 28 23:15:25 ip-172-31-1-111 systemd[1]: Starting php8.3-fpm.service - The PHP 8.3 FastCGI Process Manager...
Nov 28 23:15:25 ip-172-31-1-111 systemd[1]: Started php8.3-fpm.service - The PHP 8.3 FastCGI Process Manager.
```

nginxのエラーログを tail しながらアプリをWebで開くと以下のようなエラーが出力される。

```sh
$ sudo tail -f /var/log/nginx/error.log
2024/11/28 23:16:56 [error] 3454#3454: *1042 FastCGI sent in stderr: "PHP message: PHP Fatal error:  Uncaught PDOException: SQLSTATE[HY000] [1698] Access denied for user 'root'@'localhost' in /home/isucon/private_isu/webapp/php/index.php:57
```

`/home/isucon/private_isu/webapp/php/index.php` の57行目を確認する。DBに接続できていない、そして root ユーザで接続しようとしている。

```php
    return new PDO(
        "mysql:dbname={$config['db']['database']};host={$config['db']['host']};port={$config['db']['port']};charset=utf8mb4",
        $config['db']['username'],
        $config['db']['password']
    );
```

ここでサーバ上の `env.sh` をみると以下のような値が設定されているので本来ならこれで動きそうだけど..

```sh
ISUCONP_DB_USER=isuconp
ISUCONP_DB_PASSWORD=isuconp
ISUCONP_DB_NAME=isuconp
```

手抜きしてアプリを修正して ([c642a45](https://github.com/stefafafan/private-isu-php/commit/c642a45ff4fdfa3a8e357c3a14aaefd3487e19c8)) なんとかする。

rsyncでデプロイしなおしたら無事PHP実装が動いていることをブラウザ上で確認できる。ベンチを回して点数がでたら無事成功。

```sh
{"pass":true,"score":3288,"success":3085,"fail":0,"messages":[]}
```

## スロークエリログの有効化とpt-query-digestの設定

MySQLの設定が `/etc/mysql/mysql.conf.d/mysqld.cnf` にあるので、それをひとまず手元に持ってくる。

```sh
mkdir -p ./etc/mysql/mysql.conf.d
rsync -a isu01:/etc/mysql/mysql.conf.d/mysqld.cnf ./etc/mysql/mysql.conf.d
```

スロークエリログを有効化する: [dd32d11](https://github.com/stefafafan/private-isu-php/commit/dd32d11b4e3c6020159f764cfa028a15ebe34a09)

rsyncでサーバ上へ反映し、mysqlを再起動する。sudo権限が必要なので、 `--rsync-path="sudo rsync"` というオプションをつけている。

```sh
# ローカル上で実行
rsync -a --rsync-path="sudo rsync" ./etc/mysql/mysql.conf.d/ isu01:/etc/mysql/mysql.conf.d/

# サーバ上で
sudo systemctl restart mysql
```

`systemctl status mysql.service` と実行して特にエラー表示になっていなければ成功。

```sh
$ systemctl status mysql.service
● mysql.service - MySQL Community Server
     Loaded: loaded (/usr/lib/systemd/system/mysql.service; >
     Active: active (running) since Thu 2024-11-28 23:39:45 >
    Process: 5119 ExecStartPre=/usr/share/mysql/mysql-system>
   Main PID: 5129 (mysqld)
     Status: "Server is operational"
      Tasks: 38 (limit: 4535)
     Memory: 405.2M (peak: 405.7M)
        CPU: 639ms
     CGroup: /system.slice/mysql.service
             └─5129 /usr/sbin/mysqld
```
