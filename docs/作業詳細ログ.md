# 作業詳細ログ

ここには private-isu を解くにあたって実施している詳細の作業ログを記載します。

## 事前準備

競技用インスタンスにsshする。

```sh
ssh -i <.pemファイル> ubuntu@<Public IPv4 address>
```

isuconユーザに切り替えて、ホームディレクトリに移動

```sh
sudo su isucon
cd ~
```

### 初期データの準備

```sh
mkdir private_isu/webapp/sq
cd private_isu/
make init
```

MySQLコマンドへデータを流し込む (数分かかる)。

```sh
bunzip2 -c webapp/sql/dump.sql.bz2 | mysql -uisuconp -pisuconp
```

### 鍵の登録、~/.ssh/configの作成

`~/.ssh/authorized_keys` ファイルを作成する。isuconユーザに対して権限を付与する。

```sh
sudo mkdir ~/.ssh
sudo touch ~/.ssh/authorized_keys
sudo chown -R isucon:isucon ~/.ssh
```

GitHubの鍵を登録。

```sh
curl https://github.com/<あなたのGitHubユーザID>.keys >> ~/.ssh/authorized_keys
```

ログアウトし、pemファイルなしでログインできることを確認する。

```sh
ssh isucon@<Public IPv4 addressの値>
```

ベンチマーク用インスタンスでも同様の作業を実施する。

```sh
# ローカル
ssh -i <.pemファイル> ubuntu@<Public IPv4 address>

# サーバ上
sudo su isucon
cd ~
sudo mkdir ~/.ssh
sudo touch ~/.ssh/authorized_keys
sudo chown -R isucon:isucon ~/.ssh
curl https://github.com/<あなたのGitHubユーザID>.keys >> ~/.ssh/authorized_keys

# ローカルで確認
ssh isucon@<Public IPv4 addressの値>
```

必要な設定が終わったので、 `~/.ssh/config` を手元向けに作成する。中身は以下のような形（IPアドレスの値は実際の値と置き換える）。

```sh
Host isu01
  User isucon
  HostName <Public IPv4 addressの値>
Host isubench
  User isucon
  HostName <Public IPv4 addressの値>
```

設定が終わったら以下のようにssh可能になる。

```sh
ssh isu01
ssh isubench
```

## 動作確認とベンチマーカーの実行

競技用インスタンスのPublic IPv4 addressに直接ブラウザで (httpで) アクセスしたら「Iscogram」という名前のアプリが確認できる。

ベンチマーカーの実行はベンチマーカー用インスタンス上で以下のように実行する。

```sh
# sshした上で、
ssh isubench

# ベンチマーク実行
/home/isucon/private_isu.git/benchmarker/bin/benchmarker -u /home/isucon/private_isu.git/benchmarker/userdata -t http://<競技用インスタンスのPrivate IPv4 addresseの値>
```

以下のようなログが出力されます。

```sh
{"pass":true,"score":1026,"success":889,"fail":0,"messages":[]}
```

## rsync で必要なファイルだけ手元に持ってきて、GitHubへpushする

`isu01` 上のディレクトリ構成の感じを見つつ、以下のようなコマンドで不要なディレクトリを除外しつつ `webapp` 配下を持ってくる。

```sh
rsync -a --exclude 'sql' --exclude 'golang' --exclude 'node' --exclude 'ruby' isu01:~/private_isu/webapp ./
```

`webapp/docker-compose.yml` と `webapp/etc` は正直いらなそうなので手元から除外しつつ、必要なファイルだけ GitHub にpushしておく。

まず `.gitignore` に `vendor` を入れておく。

```.gitignore
vendor
```

その上で残りの `webapp` もcommitしてpushする。

## webapp/php 以下をサーバへ rsync

手元で composer install しつつ

```sh
cd webapp/php
composer install
```

webapp/php のみ rsyncでアップロードする。

```sh
rsync -a webapp/php/ isu01:~/private_isu/webapp/php/
```
