# 点数ログ

ここでは private-isu を解くにあたっての点数のログを一覧します。

## 初回ベンチマーク (Ruby実装): 1026点

```sh
{"pass":true,"score":1026,"success":889,"fail":0,"messages":[]}
```

## PHP実装に切り替え: 3288点

```sh
{"pass":true,"score":3288,"success":3085,"fail":0,"messages":[]}
```

## 各種計測ログや計測を仕込んだ後: 2802点

```sh
{"pass":true,"score":2802,"success":2627,"fail":0,"messages":[]}
```

| COUNT | 1XX | 2XX  | 3XX | 4XX | 5XX | METHOD |        URI         |  MIN  |  MAX  |   SUM   |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) |  MAX(BODY)  |   SUM(BODY)   | AVG(BODY)  |
|-------|-----|------|-----|-----|-----|--------|--------------------|-------|-------|---------|-------|-------|-------|-------|--------|-----------|-------------|---------------|------------|
| 103   | 0   | 103  | 0   | 0   | 0   | GET    | /                  | 0.875 | 5.175 | 275.395 | 2.674 | 3.712 | 4.270 | 5.005 | 0.823  | 4409.000  | 5886.000    | 537822.000    | 5221.573   |
| 1517  | 0   | 1517 | 0   | 0   | 0   | GET    | ^/image/.+$        | 0.001 | 2.456 | 268.300 | 0.177 | 0.520 | 0.838 | 1.912 | 0.331  | 34439.000 | 1057898.000 | 295909057.000 | 195062.002 |
| 131   | 0   | 131  | 0   | 0   | 0   | GET    | ^/posts/\d+$       | 0.042 | 2.060 | 48.283  | 0.369 | 0.883 | 1.324 | 1.657 | 0.379  | 750.000   | 1836.000    | 167699.000    | 1280.145   |

```sql
# Rank Query ID                            Response time  Calls R/Call V/M
# ==== =================================== ============== ===== ====== ===
#    1 0x624863D30DAC59FA16849282195BE09F  208.9196 67.8%  2801 0.0746  0.00 SELECT comments
#    2 0x422390B42D4DD86C7539A5F45EB76A80   79.6292 25.8%  2932 0.0272  0.00 SELECT comments
#    3 0x100EC8B5C400F34381F9D7F7FA80A53D   10.8826  3.5%   131 0.0831  0.00 SELECT comments
...
SELECT * FROM `comments` WHERE `post_id` = '10000' ORDER BY `created_at` DESC LIMIT 3\G
SELECT COUNT(*) AS `count` FROM `comments` WHERE `post_id` = '6777'\G
SELECT * FROM `comments` WHERE `post_id` = '6121' ORDER BY `created_at` DESC\G
```

![First Bench Flamegraph Result](./images/firstbench-flamegraph.svg)

## commentsテーブルへindex追加: 27353点

以下のクエリを実行。

```sql
ALTER TABLE comments ADD INDEX post_id_created_at_idx (post_id, created_at DESC);
```

```sh
{"pass":true,"score":27353,"success":25016,"fail":0,"messages":[]}
```

| COUNT | 1XX |  2XX  | 3XX | 4XX | 5XX | METHOD |          URI          |  MIN  |  MAX  |   SUM   |  AVG  |  P90  |  P95  |  P99  | STDDEV | MIN(BODY) |  MAX(BODY)  |   SUM(BODY)    | AVG(BODY)  |
|-------|-----|-------|-----|-----|-----|--------|-----------------------|-------|-------|---------|-------|-------|-------|-------|--------|-----------|-------------|----------------|------------|
| 13143 | 0   | 13143 | 0   | 0   | 0   | GET    | ^/image/.+            | 0.001 | 0.109 | 347.973 | 0.026 | 0.039 | 0.045 | 0.062 | 0.011  | 36601.000 | 1156481.000 | 4207002421.000 | 320094.531 |
| 1205  | 0   | 1205  | 0   | 0   | 0   | GET    | /                     | 0.024 | 0.160 | 115.632 | 0.096 | 0.115 | 0.122 | 0.138 | 0.016  | 2478.000  | 5871.000    | 3517612.000    | 2919.180   |
| 1522  | 0   | 1522  | 0   | 0   | 0   | GET    | ^/posts/\d+           | 0.002 | 0.110 | 47.371  | 0.031 | 0.043 | 0.049 | 0.063 | 0.010  | 708.000   | 1885.000    | 1939409.000    | 1274.250   |

```sql
# Rank Query ID                            Response time Calls R/Call V/M 
# ==== =================================== ============= ===== ====== ====
#    1 0x4858CF4D8CAA743E839C127C71B69E75  43.3642 39.2%  1205 0.0360  0.00 SELECT posts
#    2 0x19759A5557089FD5B718D440CBBB5C55  14.7213 13.3% 14665 0.0010  0.00 SELECT posts
#    3 0x396201721CD58410E070DA9421CA8C8D  11.6983 10.6% 75608 0.0002  0.00 SELECT users
...
SELECT `id`, `user_id`, `body`, `mime`, `created_at` FROM `posts` ORDER BY `created_at` DESC\G
SELECT * FROM `posts` WHERE `id` = '9951'\G
SELECT * FROM `users` WHERE `id` = '521'\G
```

![Flamegraph](./images/202412021514-flamegraph.svg)
